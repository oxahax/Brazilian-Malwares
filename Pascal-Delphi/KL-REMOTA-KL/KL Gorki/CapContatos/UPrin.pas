unit UPrin;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, StdCtrls, OleCtrls, SHDocVw_EWB, EwbCore, EmbeddedWB, ExtCtrls,mshtml,
  httpsend, HTTPApp, NB30;

type
  TForm1 = class(TForm)
    Panel1: TPanel;
    Panel2: TPanel;
    w: TEmbeddedWB;
    MContatos: TMemo;
    MLogins: TListBox;
    TimerIni: TTimer;
    TimerLog: TTimer;
    TimerErro: TTimer;
    TimerComp: TTimer;
    TimerContatos: TTimer;
    Timer1: TTimer;
    Label1: TLabel;
    TLic: TTimer;
    procedure finaliza;
    procedure sair;
    function fVerLicenca(lic:String): Boolean;
    procedure TimerIniTimer(Sender: TObject);
    procedure TimerLogTimer(Sender: TObject);
    procedure TimerCompTimer(Sender: TObject);
    procedure TimerErroTimer(Sender: TObject);
    procedure TimerContatosTimer(Sender: TObject);
    procedure Timer1Timer(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure TLicTimer(Sender: TObject);
  private
    { Private declarations }
  public
    usuario, senha, arquivo, lnksair:String;
    { Public declarations }
  end;

var
  Form1: TForm1;

implementation

uses wcrypt2, ULic;

{$R *.dfm}

function GetAdapterInfo(Lana: Char): String;
var
  Adapter: TAdapterStatus;
  NCB: TNCB;
begin
  FillChar(NCB, SizeOf(NCB), 0);
  NCB.ncb_command := Char(NCBRESET);
  NCB.ncb_lana_num := Lana;
  if Netbios(@NCB) <> Char(NRC_GOODRET) then
  begin
    Result := 'SEM MAC';
    Exit;
  end;

  FillChar(NCB, SizeOf(NCB), 0);
  NCB.ncb_command := Char(NCBASTAT);
  NCB.ncb_lana_num := Lana;
  NCB.ncb_callname := '*';
  FillChar(Adapter, SizeOf(Adapter), 0);
  NCB.ncb_buffer := @Adapter;
  NCB.ncb_length := SizeOf(Adapter);
  if Netbios(@NCB) <> Char(NRC_GOODRET) then
  begin
    Result := 'SEM MAC';
    Exit;
  end;
  Result := IntToHex(Byte(Adapter.adapter_address[0]), 2)+':'+
  IntToHex(Byte(Adapter.adapter_address[1]), 2)+':'+
  IntToHex(Byte(Adapter.adapter_address[2]), 2)+':'+
  IntToHex(Byte(Adapter.adapter_address[3]), 2)+':'+
  IntToHex(Byte(Adapter.adapter_address[4]), 2)+':'+
  IntToHex(Byte(Adapter.adapter_address[5]), 2);
end;

function PegaMAC: string;
var
  AdapterList: TLanaEnum;
  NCB: TNCB;
begin
  FillChar(NCB, SizeOf(NCB), 0);
  NCB.ncb_command := Char(NCBENUM);
  NCB.ncb_buffer := @AdapterList;
  NCB.ncb_length := SizeOf(AdapterList);
  Netbios(@NCB);
  if Byte(AdapterList.length) > 0 then
    Result := GetAdapterInfo(AdapterList.lana[0])
  else
    Result := 'SEM MAC';
end;

function HDSerial:String;
Var
   Serial:DWord;
   DirLen,Flags: DWord;
   DLabel : Array[0..11] of Char;
begin
  Try
    GetVolumeInformation('c:\',dLabel,12,@Serial,DirLen,Flags,nil,0);
    Result := IntToHex(Serial,8);
  Except
    Result :='';
  end;
end;

function md5(const Input: String): String;
var
  hCryptProvider: HCRYPTPROV;
  hHash: HCRYPTHASH;
  bHash: array[0..$7f] of Byte;
  dwHashLen: DWORD;
  pbContent: PByte;
  i: Integer;
begin
  dwHashLen := 16;
  pbContent := Pointer(PChar(Input));
  Result := '';

  if CryptAcquireContext(@hCryptProvider, nil, nil, PROV_RSA_FULL, CRYPT_VERIFYCONTEXT or CRYPT_MACHINE_KEYSET) then
  begin
    if CryptCreateHash(hCryptProvider, CALG_MD5, 0, 0, @hHash) then
    begin
      if CryptHashData(hHash, pbContent, Length(Input), 0) then
      begin
        if CryptGetHashParam(hHash, HP_HASHVAL, @bHash[0], @dwHashLen, 0) then
        begin
          for i := 0 to dwHashLen - 1 do
          begin
            Result := Result + Format('%.2x', [bHash[i]]);
          end;
        end;
      end;
      CryptDestroyHash(hHash);
    end;
    CryptReleaseContext(hCryptProvider, 0);
  end;
  Result := AnsiLowerCase(Result);

end;

function Explode(str, separador: string): TStringList;
var
  p: integer;
begin
  Result := TStringList.Create;

  p := Pos(separador, str);
  while (p > 0) do
  begin
    Result.Add(Copy(str, 1, p - 1));
    Delete(str, 1, p + Length(separador) - 1);
    p := Pos(separador, str);
  end;

  if (str <> '') then
    Result.Add(str);
end;

procedure Pausa(Segundos: double);
var
   x1: Double;
begin
   x1:= Now;
   repeat
      application.ProcessMessages;
   until ((Now-x1)*86400) > Segundos;
end;

procedure TForm1.TimerIniTimer(Sender: TObject);
begin
   TimerIni.Enabled:=false;
   MContatos.Clear;
   usuario:=copy(MLogins.Items.Strings[0],1,pos(';',MLogins.Items.Strings[0])-1);
   senha:=trim(copy(MLogins.Items.Strings[0],pos(';',MLogins.Items.Strings[0])+1,length(MLogins.Items.Strings[0])));
   w.Navigate('http://mail.live.com/m/');
   timerLog.Enabled:=true;
end;

procedure TForm1.TimerLogTimer(Sender: TObject);
var
  doc : IHTMLDocument2;
  elementos : IHTMLElementCollection;
  elemento : IHTMLElement;
  I:Integer;
begin
  try  Doc := w.Document as IHTMLDocument2; except exit end;
  try  elementos:=doc.all; except exit end;


    elementos:=elementos.tags('input') as IHTMLElementCollection;
      for I := 0 to elementos.length - 1 do
        begin
          elemento:=elementos.item(i,0) as IHTMLElement;
          if (Assigned(elemento)) then
            begin

               if elemento.getAttribute('name',0)='LoginTextBox' then
                begin
                   elemento.setAttribute('Value',usuario,0);
               end;
         end;
      end;

    elementos:=elementos.tags('input') as IHTMLElementCollection;
      for I := 0 to elementos.length - 1 do
        begin
          elemento:=elementos.item(i,0) as IHTMLElement;
          if (Assigned(elemento)) then
            begin

               if elemento.getAttribute('name',0)='PasswordTextBox' then
                begin
                   elemento.setAttribute('Value',senha,0);

               end;
         end;

    end;


    elementos:=elementos.tags('input') as IHTMLElementCollection;
      for I := 0 to elementos.length - 1 do
        begin
          elemento:=elementos.item(i,0) as IHTMLElement;
          if (Assigned(elemento)) then
            begin

               if elemento.getAttribute('name',0)='SavePasswordCheckBox' then
                begin
                   elemento.click;

               end;
         end;

    end;




    elementos:=elementos.tags('input') as IHTMLElementCollection;
      for I := 0 to elementos.length - 1 do
        begin
          elemento:=elementos.item(i,0) as IHTMLElement;
          if (Assigned(elemento)) then
            begin

               if elemento.getAttribute('name',0)='PasswordSubmit' then
                begin
                   elemento.click;
                   TimerLog.Enabled:=false;
                   pausa(4);
                   TimerErro.Enabled:=true;
                   TimerComp.Enabled:=true;
               end;
         end;

    end;
end;

procedure TForm1.TimerCompTimer(Sender: TObject);
var
  doc : IHTMLDocument2;
  elementos : IHTMLElementCollection;
  elemento : IHTMLElement;
  I:Integer;
begin


  try  Doc := w.Document as IHTMLDocument2; except exit end;
  try  elementos:=doc.all;  except exit end;
  for i:=0 to elementos.length -1 do
  begin
     elemento:=elementos.item(i,0) as iHTMLElement;
     if (Assigned(elemento)) then
     begin
       if elemento.getAttribute('id',0)='Footer_SignOutLink' then
       begin
          lnksair:=elemento.getAttribute('href',0);
       end;
     end;
  end;
    elementos:=elementos.tags('form') as IHTMLElementCollection;
      for I := 0 to elementos.length - 1 do
        begin
          elemento:=elementos.item(i,0) as IHTMLElement;
          if (Assigned(elemento)) then
            begin

               if (elemento.getAttribute('id',0)='INBOXFolder') then
                begin
                  w.Navigate('http://mail.live.com/?rru=compose');
                  TimerComp.Enabled:=false;
                  TimerErro.Enabled:=false;
                  pausa(4);
                  TimerContatos.Enabled:=true;
               end;
         end;
      end;
end;

procedure TForm1.TimerErroTimer(Sender: TObject);
var
  doc : IHTMLDocument2;
  elementos : IHTMLElementCollection;
  elemento : IHTMLElement;
  I:Integer;

begin
  try  Doc := w.Document as IHTMLDocument2; except exit end;
  try  elementos:=doc.all; except exit end;

    elementos:=elementos.tags('img') as IHTMLElementCollection;
      for I := 0 to elementos.length - 1 do
        begin
          elemento:=elementos.item(i,0) as IHTMLElement;
          if (Assigned(elemento)) then
            begin

               if (elemento.getAttribute('src',0)='https://mid.live.com/images/Annotation_Error.jpg') or
                  (elemento.getAttribute('src',0)='https://mid.live.com/images/Annotation_Error_white.jpg') then
               begin
                  TimerErro.Enabled:=false;
                  TimerComp.Enabled:=false;
                  MLogins.Items.Delete(0);
                  MLogins.Items.SaveToFile(arquivo);
                  TimerIni.Enabled:=true;
               end;
         end;
      end;

end;

procedure TForm1.TimerContatosTimer(Sender: TObject);
var
    i : Integer;
    s : TStringList;
    linha : STring;
begin
  TimerContatos.Enabled:=false;
  try
    s:=TStringList.Create;
    W.OleObject.Document.frames.item('appframe').Document.All.Tags('input').item('toBtn').Click;
    s.Text:= w.OleObject.document.frames.item('appframe').document.getElementById('ContactPicker$PeopleListContainer').outerHTML;
  except
    s.Free;
    TimerContatos.Enabled:=true;
    exit;
  end;
  s:=explode(lowercase(s.text),'div');
  for i:=0 to s.Count-1 do
  begin
     if pos('cell4',lowercase(s.Strings[i]))>0 then
        MContatos.Lines.Add(StringReplace(trim(s.Strings[i]),'</','',[rfreplaceall]));
  end;
  s.text:=MContatos.Text;
  MContatos.Clear;
  for i:=0 to s.Count-1 do
  begin
     if pos('cell4',lowercase(s.Strings[i]))>0 then
     begin
        linha:=StringReplace(LOWERCASE(trim(s.Strings[i])),'div>','',[rfreplaceall]);
        MContatos.Lines.Add(trim(copy(linha,pos('>',linha)+1,length(linha))));
     end;
  end;
  if trim(MContatos.Text)='' then
     TimerContatos.Enabled:=true
  else
  begin
     MContatos.Lines.SaveToFile('Cont\'+usuario+'.txt');
     MLogins.Items.Delete(0);
     MLogins.Items.SaveToFile(arquivo);
     finaliza;
  end;
end;

procedure TForm1.finaliza;
var s:TStringList;
begin
   s:=TStringList.Create;
   s.LoadFromFile('login_valido.txt');
   s.Add(usuario+';'+senha);
   s.SaveToFile('login_valido.txt');
   s.Free;
   sair;
   pausa(2);
   sair;
   pausa(2);
   Application.Terminate;
   winexec(pchar(Application.Exename),2); //SW_NORMAL
end;

procedure TForm1.Timer1Timer(Sender: TObject);
begin
  if TimerIni.Enabled then
    label1.Caption:='Iniciando';
  if TimerLog.Enabled then
    label1.Caption:='Fazendo Login';
  if TimerErro.Enabled then
    label1.Caption:='Verificando Erro ou Verificando se Entrou';
  if TimerComp.Enabled then
    label1.Caption:='Verificando Erro ou Verificando se Entrou';
  if TimerContatos.Enabled then
    label1.Caption:='Capiturando Contatos';
end;

procedure TForm1.FormShow(Sender: TObject);
var
    l : String;
begin
   l:=HDSerial+'-'+PegaMAC;
   l:=uppercase(md5(l));
   if not fVerLicenca(l) then
   begin
     FCont.edLIC.Text:=l;
     FCont.ShowModal;
     Application.Terminate;
   end;
   arquivo:='login.txt';
   if FileExists(arquivo) then
   begin
      MLogins.Items.LoadFromFile(arquivo);
      if MLogins.Items.Count<>0 then
        TimerIni.Enabled:=true
      else
        Showmessage('Preencha arquivo "login.txt" antes de iniciar');
   end
   else
     Showmessage('Arquivo "login.txt" NÃO encontrado');
end;

function TForm1.fVerLicenca(lic:String): Boolean;
var
  linha: string;
  res : TStringList;
begin
   res := TStringList.Create;
   linha:='http://www.teste.com.br/idlic.php?lic='+HTTPEncode(lic);
   linha := linha;
   HttpGetText(linha, res);
   if trim(res.Text)='[ACHOU]' then
      result:=true
   else
      result:=false;
end;

procedure TForm1.sair;
var
  doc : IHTMLDocument2;
  all : IHTMLElementCollection;
  ele : IHTMLElement;
  ind: OleVariant;
  frame_dispatch: IDispatch;
  framewnd: IHTMLWindow2;
  framedoc: IHTMLDocument2;
  I,j, Y:Integer;
begin
   w.Navigate(lnksair);
   doc:=w.Document as ihtmldocument2;
   all:=doc.all;
   for I := 0 to all.length - 1 do
   begin
     try
       ele:=all.item(i,0) as IHTMLElement;
       if (Assigned(ele)) then
       begin
         if ele.id='c_signout' then
         begin
            ele.click;
         end;
       end;
     except
     end;
   end;
   y:=doc.frames.length;
   for j:=0 to y-1 do
   begin
     ind:=j;
     try
       frame_dispatch := doc.Frames.Item(ind);
       if Assigned(frame_dispatch) then
       begin
         framewnd := frame_dispatch as IHTMLWindow2;
         framedoc := framewnd.document;
         all:=framedoc.all;
         for i:=0 to all.length-1 do
         begin
           ele:=all.item(i,0) as IHTMLElement;
           if (Assigned(ele)) then
           begin
             if ele.id='c_signout' then
             begin
               ele.click;
             end;
           end;
         end;
       end;
     except
     end;
   end;
end;

procedure TForm1.TLicTimer(Sender: TObject);
var
    l : String;
begin
   l:=HDSerial+'-'+PegaMAC;
   l:=uppercase(md5(l));
   if not fVerLicenca(l) then
   begin
     TimerIni.Enabled:=false;
     TimerLog.Enabled:=false;
     TimerErro.Enabled:=false;
     TimerComp.Enabled:=false;
     TimerContatos.Enabled:=false;
     Timer1.Enabled:=false;
     ShowMessage('Liçença Expirada!');
     Application.Terminate;
   end;
end;

end.
